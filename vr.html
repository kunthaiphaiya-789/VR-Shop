<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vannay Shop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2canvas library for saving HTML content as an image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background 0.3s, color 0.3s;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196f3;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border: #dee2e6;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --sidebar-width: 260px;
            --header-height: 70px;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo i {
            font-size: 28px;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.15);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo h1 {
            font-size: 22px;
            font-weight: 600;
        }

        .nav-section {
            margin: 25px 0;
        }

        .nav-title {
            padding: 0 20px;
            font-size: 14px;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            padding: 0;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s;
            font-size: 16px;
            border-left: 3px solid transparent;
        }

        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid var(--accent);
        }

        .nav-links i {
            width: 24px;
            margin-right: 15px;
            font-size: 18px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
        }

        .header {
            height: var(--header-height);
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .header h2 {
            font-size: 24px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h2 i {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.15);
            padding: 10px;
            border-radius: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            border-radius: 30px;
            border: 1px solid var(--light-gray);
            width: 250px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .notification, .user-profile, .language-selector {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: all 0.3s;
        }

        .language-selector {
            width: auto; /* Adjust width to fit text + icon */
            padding: 0 10px; /* Add padding for text */
            border-radius: 20px; /* More rounded for button-like appearance */
            gap: 5px; /* Space between text and icon */
        }

        .notification:hover, .user-profile:hover, .language-selector:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .notification::after {
            content: "3";
            position: absolute;
            top: -3px;
            right: -3px;
            background: var(--danger);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Content Area */
        .content-area {
            padding: 30px;
            min-height: calc(100vh - var(--header-height));
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .bg-blue {
            background: rgba(67, 97, 238, 0.15);
            color: var(--primary);
        }

        .bg-green {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success);
        }

        .bg-orange {
            background: rgba(255, 152, 0, 0.15);
            color: var(--warning);
        }

        .bg-purple {
            background: rgba(156, 39, 176, 0.15);
            color: #9c27b0;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            background: var(--light);
            color: var(--gray);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Content Containers */
        .content-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            margin-bottom: 30px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .content-header h3 {
            font-size: 22px;
            color: var(--dark);
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--gray);
            color: var(--gray);
        }

        .btn-outline:hover {
            background: var(--light-gray);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #3d8b40;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: var(--light);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        tr:hover {
            background: rgba(67, 97, 238, 0.03);
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-active {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success);
        }

        .status-pending {
            background: rgba(255, 152, 0, 0.15);
            color: var(--warning);
        }

        .status-inactive {
            background: rgba(108, 117, 125, 0.15);
            color: var(--gray);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            border: none;
        }

        .edit-btn {
            background: rgba(33, 150, 243, 0.15);
            color: var(--info);
        }

        .delete-btn {
            background: rgba(244, 67, 54, 0.15);
            color: var(--danger);
        }

        .view-btn {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success);
        }

        /* Settings Page */
        .theme-colors {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .color-option.selected {
            border-color: var(--dark);
            transform: scale(1.1);
        }

        /* Language Switcher */
        .language-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .lang-option {
            padding: 10px 20px;
            border-radius: 8px;
            background: var(--light);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .lang-option.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 22px;
            color: var(--dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
            padding: 0 20px 20px;
        }

        /* Order Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .items-table th {
            background: var(--light);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .items-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .items-table input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
        }

        .items-table input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .add-item-btn {
            margin-top: 10px;
            background: var(--light);
            border: 1px dashed var(--gray);
            color: var(--gray);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .add-item-btn:hover {
            background: var(--light-gray);
        }

        .remove-item {
            color: var(--danger);
            cursor: pointer;
            font-size: 18px;
            text-align: center;
        }

        /* Summary Card */
        .summary-card {
            background: var(--light);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary);
            padding-top: 15px;
        }

        .currency-toggle {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
        }

        .currency-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .currency-option.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: flex;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
            }
            
            .search-box input {
                width: 180px;
            }
            
            .content-area {
                padding: 20px;
            }
            
            .content-container {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
        }

        @media (max-width: 576px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .header h2 span {
                display: none;
            }
            
            .search-box {
                display: none;
            }
            
            .tabs {
                overflow-x: auto;
                padding-bottom: 5px;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: var(--success);
        }

        .toast-error {
            background: var(--danger);
        }

        /* Menu Toggle */
        .menu-toggle {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            margin-right: 15px;
        }

        @media (max-width: 992px) {
            .menu-toggle {
                display: flex;
            }
        }

        /* Section Content */
        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .text-warning {
            color: var(--warning);
        }
        
        /* Product Grid Styles */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .product-image {
            height: 200px;
            width: 100%;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 20px;
        }

        .product-info h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .product-category {
            display: inline-block;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }

        .product-description {
            color: var(--gray);
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .product-pricing {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .price-usd {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
        }

        .price-khr {
            font-size: 1rem;
            color: var(--gray);
        }

        .product-stock {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .stock-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .in-stock {
            background: var(--success);
        }

        .low-stock {
            background: var(--warning);
        }

        .out-of-stock {
            background: var(--danger);
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 35px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .edit-btn {
            background: rgba(33, 150, 243, 0.15);
            color: var(--info);
        }

        .delete-btn {
            background: rgba(244, 67, 54, 0.15);
            color: var(--danger);
        }

        .detail-btn { /* New style for detail button */
            background: rgba(76, 201, 240, 0.15);
            color: var(--accent);
        }
        
        .add-product-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 30px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-product-btn:hover {
            background: var(--primary-dark);
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--light-gray);
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            position: relative;
        }

        .image-upload:hover {
            border-color: var(--accent);
            background: rgba(76, 201, 240, 0.05);
        }

        .image-upload i {
            font-size: 48px;
            color: var(--gray);
            margin-bottom: 15px;
        }

        .image-upload p {
            color: var(--gray);
            margin-bottom: 10px;
        }

        .image-upload small {
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* Specific style for image preview within modals */
        .modal-body #imagePreview, 
        .modal-body #customerImagePreview {
            max-width: 100%;
            max-height: 200px;
            margin: 0 auto 20px;
            border-radius: 8px;
            display: none; /* Hidden by default */
            object-fit: cover; /* Ensures image covers the area nicely */
        }
        
        /* Order Settings */
        .order-settings {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .setting-group {
            background: white;
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            min-width: 200px;
            box-shadow: var(--card-shadow);
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .setting-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
        }
        
        /* Order Summary */
        .order-summary-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            margin: 20px auto;
            box-shadow: var(--card-shadow);
        }
        
        .order-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 15px;
        }
        
        .order-header h2 {
            color: var(--primary);
            font-size: 28px;
        }
        
        .order-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .order-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .order-items-table th {
            background: var(--light);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }
        
        .order-items-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .order-totals {
            margin-top: 30px;
            border-top: 2px solid var(--border);
            padding-top: 20px;
        }
        
        .order-total-row {
            display: flex;
            justify-content: flex-end;
            padding: 8px 0;
        }
        
        .order-total-label {
            width: 200px;
            text-align: right;
            font-weight: 500;
        }
        
        .order-total-value {
            width: 150px;
            text-align: right;
            font-weight: 600;
        }
        
    .grand-total {
        font-size: 20px;
        color: var(--primary);
    }
        
        .thank-you {
            text-align: center;
            margin-top: 30px;
            font-style: italic;
            color: var(--gray);
            border-top: 1px dashed var(--light-gray);
            padding-top: 20px;
        }
        
        /* Print Actions */
        .print-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .print-btn {
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }
        
        .print-btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .print-btn-success {
            background: var(--success);
            color: white;
        }

        .print-btn-secondary {
            background: var(--gray);
            color: white;
        }

        /* Transaction Filters */
        .transaction-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .transaction-filters .btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            background: var(--light-gray);
            color: var(--dark);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transaction-filters .btn.active-filter {
            background: var(--primary);
            color: white;
        }

        /* Customer Detail Specific Styles */
        .customer-detail-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 20px;
        }

        .customer-detail-info p {
            font-size: 1.1rem;
            color: var(--dark);
        }

        .customer-detail-info p strong {
            color: var(--gray);
            margin-right: 10px;
        }

        .customer-financial-summary {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--light);
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }

        .financial-item {
            flex: 1;
            min-width: 150px; /* Ensure items don't get too squished */
            padding: 10px;
        }

        .financial-item h4 {
            font-size: 1.2rem;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .financial-item .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .add-redeem-credit-section { /* Combined section for adding and redeeming */
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
            margin-top: 20px;
        }

        .credit-action-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px; /* Spacing between add and redeem sections */
        }

        .credit-action-group input[type="number"] {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
        }

        .credit-action-group select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
            background-color: white;
            cursor: pointer;
        }

        .credit-action-group .btn {
            padding: 10px 20px;
        }

        .credit-history-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .credit-history-section h4 {
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 15px;
        }

        .credit-history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .credit-history-table th, .credit-history-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--light-gray);
            text-align: left;
        }

        .credit-history-table th {
            background: var(--light);
            font-weight: 600;
        }

        .no-history-message {
            text-align: center;
            color: var(--gray);
            padding: 20px;
        }

        /* Customer grid and pagination */
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .customer-card-item {
            background: white; /* Changed from light-gray to white for consistency with other cards */
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column; /* Changed to column to stack elements */
            align-items: center;
            gap: 10px; /* Adjusted gap */
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center; /* Center content horizontally */
        }

        .customer-card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .customer-card-item .profile-avatar {
            width: 80px; /* Larger avatar */
            height: 80px; /* Larger avatar */
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-gray); /* Background for default avatar */
            flex-shrink: 0;
            margin-bottom: 10px; /* Space below avatar */
            border: 2px solid var(--primary); /* Added border */
        }

        .customer-card-item .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .customer-card-item .profile-info {
            flex-grow: 1;
            width: 100%; /* Take full width */
        }

        .customer-card-item .profile-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.2rem; /* Slightly larger font */
            margin-bottom: 5px;
            white-space: nowrap; /* Prevent name from wrapping */
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis if name is too long */
        }

        .customer-card-item .customer-card-actions { /* New container for action buttons */
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px; /* Space above buttons */
        }

        .customer-card-item .action-btn {
            padding: 8px 35px;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: unset; /* Override general action-btn width */
        }

        .customer-card-item .view-profile-btn { /* Re-purposed to be one of the action buttons */
            background: var(--primary);
            color: white;
            padding: 8px 35px;
            border-radius: 6px; /* Match other action buttons */
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }

        .customer-card-item .view-profile-btn:hover {
            background: var(--primary-dark);
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .page-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s, opacity 0.3s;
        }

        .page-button:disabled {
            background: var(--gray);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .page-button:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        /* Review specific styles */
        .rating-stars {
            color: #ffc107; /* Gold color for stars */
            font-size: 1.2rem;
        }
        .rating-stars .far {
            color: #e0e0e0; /* Lighter color for empty stars */
        }

        /* Customer Orders Table within Detail Modal */
        .customer-orders-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .customer-orders-section h4 {
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 15px;
        }

        .customer-orders-table {
            width: 100%;
            border-collapse: collapse;
        }

        .customer-orders-table th, .customer-orders-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--light-gray);
            text-align: left;
        }

        .customer-orders-table th {
            background: var(--light);
            font-weight: 600;
        }

        .no-orders-message {
            text-align: center;
            color: var(--gray);
            padding: 20px;
        }

        /* Action button in tables */
        .customer-orders-table .action-btn {
            padding: 5px 10px; /* Smaller padding for table buttons */
            font-size: 0.85rem;
            width: auto;
            height: auto;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-store"></i>
            <h1>VANNARY SHOP</h1>
        </div>
        
        <div class="nav-section">
            <div class="nav-title">Main</div>
            <ul class="nav-links">
                <li><a href="#" class="active" data-section="dashboard" data-i18n-key="dashboardTitle"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                <li><a href="#" data-section="products" data-i18n-key="productsTitle"><i class="fas fa-box"></i> <span>Products</span></a></li>
                <li><a href="#" data-section="orders" data-i18n-key="ordersTitle"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
                <li><a href="#" data-section="customers" data-i18n-key="customersTitle"><i class="fas fa-users"></i> <span>Customers</span></a></li>
                <li><a href="#" data-section="transactions" data-i18n-key="transactionsTitle"><i class="fas fa-exchange-alt"></i> <span>Transactions</span></a></li>
            </ul>
        </div>

        <div class="nav-section">
            <div class="nav-title">Management</div>
            <ul class="nav-links">
                <li><a href="#" data-section="reviews" data-i18n-key="reviewsTitle"><i class="fas fa-star"></i> <span>Reviews</span></a></li>
                <li><a href="#" data-section="notifications" data-i18n-key="notificationsTitle"><i class="fas fa-bell"></i> <span>Notifications</span></a></li>
                <li><a href="#" data-section="messages" data-i18n-key="messagesTitle"><i class="fas fa-comments"></i> <span>Messages</span></a></li>
            </ul>
        </div>

        <div class="nav-section">
            <div class="nav-title">Marketing</div>
            <ul class="nav-links">
                <li><a href="#" data-section="coupons" data-i18n-key="couponsTitle"><i class="fas fa-tag"></i> <span>Coupons</span></a></li>
                <li><a href="#" data-section="reports" data-i18n-key="reportsTitle"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
            </ul>
        </div>
        
        <div class="nav-section">
            <div class="nav-title">System</div>
            <ul class="nav-links">
                <li><a href="#" data-section="settings" data-i18n-key="settingsTitle"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <h2><i class="fas fa-home"></i> <span data-i18n-key="dashboardTitle">Dashboard</span></h2>
            </div>
            <div class="user-info">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search...">
                </div>
                <div class="user-actions">
                    <div class="notification">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="language-selector" id="languageSelector">
                        <span id="currentLanguage">EN</span>
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="user-profile">
                        <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="Admin User">
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="content-area section-content active" id="dashboard">
            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon bg-blue">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title" data-i18n-key="totalOrdersTitle">Total Orders</div>
                        <div class="stat-value"></div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-green">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title">Revenue</div>
                        <div class="stat-value"></div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-orange">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title">Customers</div>
                        <div class="stat-value"></div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-purple">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title">Products</div>
                        <div class="stat-value"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="content-container">
                <div class="content-header">
                    <h3 data-i18n-key="recentOrdersTitle">Recent Orders</h3>
                    <button class="btn btn-primary" id="addOrderBtn" data-i18n-key="newOrderBtn">
                        <i class="fas fa-plus"></i> New Order
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersTableBody">
                            <!-- Recent orders will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top 30 Customers by Total Spent -->
            <div class="content-container" id="topCustomersSpentContainer">
                <div class="content-header">
                    <h3>Customers Spent</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Customer Name</th>
                                <th>Total Spent (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="topCustomersSpentTableBody">
                            <!-- Top customers by total spent will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top 30 Customers by Net Balance (Credit) -->
            <div class="content-container" id="topCustomersCreditContainer">
                <div class="content-header">
                    <h3>Customers Credit</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Customer Name</th>
                                <th>Net Balance (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="topCustomersCreditTableBody">
                            <!-- Top customers by credit will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Products Section - Enhanced with grid view -->
        <div class="content-area section-content" id="products">
            <div class="content-container">
                <div class="content-header">
                    <h3 data-i18n-key="productsTitle">Product Management</h3>
                    <button class="btn btn-primary" id="addProductBtn" data-i18n-key="addProductBtn">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
                
                <button class="add-product-btn" id="addProductBtnGrid" data-i18n-key="addProductBtn">
                    <i class="fas fa-plus"></i> Add New Product
                </button>
                
                <div class="products-grid" id="productsGrid">
                    <!-- Products will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <!-- Orders Section -->
        <div class="content-area section-content" id="orders">
            <div class="content-container">
                <div class="content-header">
                    <h3 data-i18n-key="ordersTitle">Order Management</h3>
                    <button class="btn btn-primary" id="addOrderBtn2" data-i18n-key="newOrderBtn">
                        <i class="fas fa-plus"></i> New Order
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Total (USD)</th>
                                <th>Total (KHR)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orderManagementTableBody">
                            <!-- All orders will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div class="content-area section-content" id="customers">
            <div class="content-container">
                <div class="content-header">
                    <h3 data-i18n-key="customersTitle">Customer Management</h3>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="customerSearchInput" placeholder="Search customer...">
                        </div>
                        <button class="btn btn-primary" id="addCustomerBtn" data-i18n-key="addCustomerBtn">
                            <i class="fas fa-user-plus"></i> Add Customer
                        </button>
                    </div>
                </div>
                
                <!-- NEW: Customer Grid instead of Table -->
                <div class="customer-grid" id="customerGrid">
                    <!-- Customer cards will be dynamically added here -->
                </div>
                
                <!-- NEW: Pagination Controls -->
                <div class="pagination-controls">
                    <button class="page-button" id="prevPageBtn" disabled>
                        <i class="fas fa-angle-double-left"></i> PREV
                    </button>
                    <button class="page-button" id="nextPageBtn">
                        NEXT <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="content-area section-content" id="transactions">
            <div class="content-container">
                <div class="content-header">
                    <h3 data-i18n-key="transactionHistoryTitle">Transaction History</h3>
                </div>
                
                <div class="transaction-filters">
                    <button class="btn active-filter" data-filter="all" id="filterAll" data-i18n-key="filterAll">All</button>
                    <button class="btn" data-filter="day" id="filterDay" data-i18n-key="filterDay">Day</button>
                    <button class="btn" data-filter="week" id="filterWeek" data-i18n-key="filterWeek">Week</button>
                    <button class="btn" data-filter="month" id="filterMonth" data-i18n-key="filterMonth">Month</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount (USD)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Transactions will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reviews Section (NEW) -->
        <div class="content-area section-content" id="reviews">
            <div class="content-container">
                <div class="content-header">
                    <h3 data-i18n-key="reviewsTitle">Customer Reviews</h3>
                    <button class="btn btn-primary" id="addReviewBtn" data-i18n-key="addReviewBtn">
                        <i class="fas fa-plus"></i> Add Review
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Review ID</th>
                                <th>Product</th>
                                <th>Customer</th>
                                <th>Rating</th>
                                <th>Comment</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reviewsTableBody">
                            <!-- Reviews will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Create New Order</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Form content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Add New Product</h3>
                <button class="close-modal" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName">Product Name *</label>
                        <input type="text" id="productName" required placeholder="Enter product name">
                    </div>
                    
                    <div class="form-group">
                        <label for="productCategory">Category *</label>
                        <select id="productCategory" required>
                            <option value="">Select category</option>
                            <option value="electronics">Electronics</option>
                            <option value="clothing">Clothing</option>
                            <option value="home">Home & Garden</option>
                            <option value="accessories">Accessories</option>
                            <option value="books">Books</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" placeholder="Enter product description"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="priceUsd">Price (USD) *</label>
                            <input type="number" id="priceUsd" min="0" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="priceKhr">Price (KHR)</label>
                            <input type="number" id="priceKhr" min="0" placeholder="0" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockQuantity">Stock Quantity *</label>
                            <input type="number" id="stockQuantity" min="0" required placeholder="Enter quantity">
                        </div>
                        <div class="form-group">
                            <label for="stockStatus">Stock Status</label>
                            <select id="stockStatus" required>
                                <option value="in-stock">In Stock</option>
                                <option value="low-stock">Low Stock</option>
                                <option value="out-of-stock">Out of Stock</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Product Image</label>
                        <div class="image-upload" id="imageUpload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload product image</p>
                            <small>JPG, PNG or GIF - Max 5MB</small>
                            <input type="file" id="productImage" accept="image/*" style="display: none;">
                        </div>
                        <img id="imagePreview" src="" alt="Image preview">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancelProductForm">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveProductBtn">
                            <i class="fas fa-save"></i> Save Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">Add New Customer</h3>
                <button class="close-modal" id="closeCustomerModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="form-group">
                        <label for="customerProfileName">Customer Name *</label>
                        <input type="text" id="customerProfileName" required placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label for="customerProfilePhone">Phone Number</label>
                        <input type="text" id="customerProfilePhone" placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label for="customerProfileEmail">Email</label>
                        <input type="email" id="customerProfileEmail" placeholder="Enter email address">
                    </div>

                    <!-- NEW: Customer Image Upload Section -->
                    <div class="form-group">
                        <label>Customer Photo</label>
                        <div class="image-upload" id="customerImageUpload">
                            <i class="fas fa-camera"></i>
                            <p>Click to upload customer photo</p>
                            <small>JPG, PNG or GIF - Max 5MB</small>
                            <input type="file" id="customerPhoto" accept="image/*" style="display: none;">
                        </div>
                        <img id="customerImagePreview" src="" alt="Customer photo preview">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancelCustomerForm">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveCustomerBtn">
                            <i class="fas fa-save"></i> Save Customer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal (NEW) -->
    <div class="modal" id="customerDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerDetailModalTitle">Customer Details</h3>
                <button class="close-modal" id="closeCustomerDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="customer-detail-info">
                    <p><strong>Name:</strong> <span id="detailCustomerName"></span></p>
                    <p><strong>Phone:</strong> <span id="detailCustomerPhone"></span></p>
                    <p><strong>Email:</strong> <span id="detailCustomerEmail"></span></p>
                </div>

                <div class="customer-financial-summary">
                    <div class="financial-item">
                        <h4>Total Orders</h4>
                        <span class="value" id="detailTotalOrders">0</span>
                    </div>
                    <div class="financial-item">
                        <h4>Total Spent</h4>
                        <span class="value">
                            <span id="detailCustomerTotalSpentUsd">$0.00</span><br>
                            <small id="detailCustomerTotalSpentKhr">0</small>
                        </span>
                    </div>
                    <div class="financial-item">
                        <h4>Net Balance</h4>
                        <span class="value">
                            <span id="detailCustomerCreditUsd">$0.00</span><br>
                            <small id="detailCustomerCreditKhr">0</small>
                        </span>
                    </div>
                </div>

                <div class="add-redeem-credit-section">
                    <h4>Manage Credit</h4>
                    <div class="credit-action-group">
                        <input type="number" id="addCreditAmount" min="0" step="0.01" placeholder="Amount to add">
                        <select id="addCreditCurrency">
                            <option value="USD">USD</option>
                            <option value="KHR">KHR</option>
                        </select>
                        <button class="btn btn-success" id="addCreditBtn">Add Credit</button>
                    </div>
                    <div class="credit-action-group" style="margin-top:15px;">
                        <input type="number" id="redeemCreditAmount" min="0" step="0.01" placeholder="Amount to redeem">
                        <select id="redeemCreditCurrency">
                            <option value="USD">USD</option>
                            <option value="KHR">KHR</option>
                        </select>
                        <button class="btn btn-primary" id="redeemCreditBtn">Redeem Credit</button>
                    </div>
                </div>

                <div class="credit-history-section" id="creditHistorySection" style="display:none;">
                    <h4>Credit Redemption History</h4>
                    <table class="credit-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="creditHistoryTableBody">
                            <!-- Credit history will be dynamically loaded here -->
                        </tbody>
                    </table>
                    <p class="no-history-message" id="noCreditHistoryMessage" style="display:none;">No credit redemption history.</p>
                </div>

                <!-- NEW: Customer Orders Section -->
                <div class="customer-orders-section" id="customerOrdersSection">
                    <h4>Orders History</h4>
                    <table class="customer-orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Total (USD)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerOrdersTableBody">
                            <!-- Customer orders will be dynamically loaded here -->
                        </tbody>
                    </table>
                    <p class="no-orders-message" id="noCustomerOrdersMessage" style="display:none;">No orders found for this customer.</p>
                </div>

                <div class="form-actions" style="justify-content: center; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" id="closeCustomerDetailBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Summary Modal -->
    <div class="modal" id="summaryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Order Summary</h3>
                <button class="close-modal" id="closeSummaryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="order-summary-container" id="orderPrintContent">
                    <div class="order-header">
                        <h2>Vannary Shop</h2>
                        <p>123 Business Street, Svay Ring, Cambodia</p>
                        <p>Phone: +855 974606774 | Email: info@vannaryashop.com</p>
                    </div>
                    
                    <div class="order-details">
                        <div>
                            <p><strong>Order ID:</strong> <span id="summaryOrderId"></span></p>
                            <p><strong>Date:</strong> <span id="summaryOrderDate"></span></p>
                        </div>
                        <div>
                            <p><strong>Customer:</strong> <span id="summaryCustomer"></span></p>
                            <p><strong>Phone:</strong> <span id="summaryPhone"></span></p>
                        </div>
                    </div>
                    
                    <table class="order-items-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price (USD)</th>
                                <th>Qty</th>
                                <th>Total (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="summaryItems">
                            <!-- Items will be inserted here -->
                        </tbody>
                    </table>
                    
                    <div class="order-totals">
                        <div class="order-total-row">
                            <div class="order-total-label">Subtotal:</div>
                            <div class="order-total-value" id="summarySubtotal">$0.00</div>
                        </div>
                        <div class="order-total-row">
                            <div class="order-total-label">Tax (<span id="summaryTaxRate">0</span>%):</div>
                            <div class="order-total-value" id="summaryTax">$0.00</div>
                        </div>
                        <div class="order-total-row">
                            <div class="order-total-label">Discount (<span id="summaryDiscountRate">0</span>%):</div>
                            <div class="order-total-value" id="summaryDiscount">$0.00</div>
                        </div>
                        <div class="summary-row">
                            <span>Points Applied (<span id="summaryPointRate">0</span>%):</span>
                            <span id="summaryPoints">$0.00</span>
                        </div>
                        <div class="order-total-row">
                            <div class="order-total-label">Applied Credit:</div>
                            <div class="order-total-value" id="summaryAppliedCredit">$0.00</div>
                        </div>
                        <div class="order-total-row">
                            <div class="order-total-label">Cash Paid:</div>
                            <div class="order-total-value" id="summaryCashPaid">$0.00</div>
                        </div>
                        <div class="order-total-row grand-total">
                            <div class="order-total-label">Grand Total (USD):</div>
                            <div class="order-total-value" id="summaryGrandTotalUsd">$0.00</div>
                        </div>
                        <div class="order-total-row grand-total">
                            <div class="order-total-label">Grand Total (KHR):</div>
                            <div class="order-total-value" id="summaryGrandTotalKhr">0</div>
                        </div>
                        <div class="order-total-row">
                            <div class="order-total-label">Remaining Balance:</div>
                            <div class="order-total-value" id="summaryRemainingBalance">$0.00</div>
                        </div>
                    </div>
                    
                    <div class="thank-you">
                        <p>Thank you for your business!</p>
                        <p>Vannary Shop- Professional Retail Management Solution</p>
                    </div>
                </div>
                
                <div class="print-actions">
                    <button class="print-btn print-btn-primary" id="printOrderBtn">
                        <i class="fas fa-print"></i> Print Order
                    </button>
                    <button class="print-btn print-btn-success" id="saveOrderImageBtn">
                        <i class="fas fa-download"></i> Save as Image
                    </button>
                    <button class="print-btn print-btn-secondary" id="doneSummaryBtn">
                        <i class="fas fa-check-circle"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal (NEW) -->
    <div class="modal" id="reviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reviewModalTitle">Add New Review</h3>
                <button class="close-modal" id="closeReviewModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <div class="form-group">
                        <label for="reviewProduct">Product *</label>
                        <select id="reviewProduct" required>
                            <option value="">Select product</option>
                            <!-- Product options will be dynamically loaded here -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewCustomer">Customer *</label>
                        <select id="reviewCustomer" required>
                            <option value="">Select customer</option>
                            <!-- Customer options will be dynamically loaded here -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewRating">Rating *</label>
                        <select id="reviewRating" required>
                            <option value="">Select rating</option>
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="2">2 Stars</option>
                            <option value="1">1 Star</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewComment">Comment</label>
                        <textarea id="reviewComment" placeholder="Enter your review comment"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancelReviewForm">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveReviewBtn">
                            <i class="fas fa-save"></i> Save Review
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Order created successfully!</span>
    </div>

    <script>
        // DOM elements
        const sidebarLinks = document.querySelectorAll('.nav-links a');
        const sectionContents = document.querySelectorAll('.section-content');
        const menuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const headerTitle = document.querySelector('.header h2 span');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModal = document.getElementById('closeModal');
        const addOrderBtn = document.getElementById('addOrderBtn');
        const addOrderBtn2 = document.getElementById('addOrderBtn2');
        const addProductBtn = document.getElementById('addProductBtn');
        const addProductBtnGrid = document.getElementById('addProductBtnGrid');
        const productModal = document.getElementById('productModal');
        const productModalTitle = document.getElementById('productModalTitle');
        const customerModal = document.getElementById('customerModal'); 
        const customerModalTitle = document.getElementById('customerModalTitle'); 
        const closeCustomerModal = document.getElementById('closeCustomerModal'); 
        const addCustomerBtn = document.getElementById('addCustomerBtn'); 
        const customerGrid = document.getElementById('customerGrid');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const customerSearchInput = document.getElementById('customerSearchInput');

        const customerDetailModal = document.getElementById('customerDetailModal');
        const closeCustomerDetailModal = document.getElementById('closeCustomerDetailModal');
        const closeCustomerDetailBtn = document.getElementById('closeCustomerDetailBtn');
        const redeemCreditBtn = document.getElementById('redeemCreditBtn'); 
        const redeemCreditAmountInput = document.getElementById('redeemCreditAmount');
        const redeemCreditCurrencySelect = document.getElementById('redeemCreditCurrency');
        const addCreditBtn = document.getElementById('addCreditBtn');
        const addCreditAmountInput = document.getElementById('addCreditAmount');
        const addCreditCurrencySelect = document.getElementById('addCreditCurrency');
        const creditHistoryTableBody = document.getElementById('creditHistoryTableBody');
        const creditHistorySection = document.getElementById('creditHistorySection');
        const noCreditHistoryMessage = document.getElementById('noCreditHistoryMessage');

        // NEW: Customer orders table elements
        const customerOrdersTableBody = document.getElementById('customerOrdersTableBody');
        const customerOrdersSection = document.getElementById('customerOrdersSection');
        const noCustomerOrdersMessage = document.getElementById('noCustomerOrdersMessage');

        const summaryModal = document.getElementById('summaryModal');
        const closeSummaryModal = document.getElementById('closeSummaryModal');
        const productsGrid = document.getElementById('productsGrid');
        const recentOrdersTableBody = document.getElementById('recentOrdersTableBody');
        const orderManagementTableBody = document.getElementById('orderManagementTableBody');
        const transactionsTableBody = document.getElementById('transactionsTableBody');
        const doneSummaryBtn = document.getElementById('doneSummaryBtn');

        // Review modal elements (NEW)
        const reviewModal = document.getElementById('reviewModal');
        const reviewModalTitle = document.getElementById('reviewModalTitle');
        const closeReviewModal = document.getElementById('closeReviewModal');
        const addReviewBtn = document.getElementById('addReviewBtn');
        const reviewsTableBody = document.getElementById('reviewsTableBody');

        // Filter buttons for transactions
        const filterAllBtn = document.getElementById('filterAll');
        const filterDayBtn = document.getElementById('filterDay');
        const filterWeekBtn = document.getElementById('filterWeek');
        const filterMonthBtn = document.getElementById('filterMonth');

        // Language selector elements
        const languageSelector = document.getElementById('languageSelector');
        const currentLanguageSpan = document.getElementById('currentLanguage');

        // New dashboard table bodies
        const topCustomersSpentTableBody = document.getElementById('topCustomersSpentTableBody');
        const topCustomersCreditTableBody = document.getElementById('topCustomersCreditTableBody');

        // NEW: Customer image upload elements
        const customerImageUpload = document.getElementById('customerImageUpload');
        const customerPhotoInput = document.getElementById('customerPhoto');
        const customerImagePreview = document.getElementById('customerImagePreview');


        // Currency conversion rate (1 USD = 4000 KHR)
        const USD_TO_KHR = 4000;

        // Supported languages
        const supportedLanguages = [
            { code: 'EN', name: 'English' },
            { code: 'KM', name: 'Khmer' },
            { code: 'ZH', name: '' } // Chinese
        ];
        let currentLanguageIndex = 0; // Start with English

        // Translations object (NEW)
        const translations = {
            'EN': {
                'dashboardTitle': 'Dashboard',
                'totalOrdersTitle': 'Total Orders',
                'recentOrdersTitle': 'Recent Orders',
                'productsTitle': 'Product Management',
                'ordersTitle': 'Order Management',
                'customersTitle': 'Customer Management',
                'transactionsTitle': 'Transaction History',
                'reviewsTitle': 'Reviews',
                'notificationsTitle': 'Notifications',
                'messagesTitle': 'Messages',
                'couponsTitle': 'Coupons',
                'reportsTitle': 'Reports',
                'settingsTitle': 'Settings',
                'newOrderBtn': 'New Order',
                'addProductBtn': 'Add Product',
                'addCustomerBtn': 'Add Customer',
                'transactionHistoryTitle': 'Transaction History',
                'filterAll': 'All',
                'filterDay': 'Day',
                'filterWeek': 'Week',
                'filterMonth': 'Month',
                'addProdBtnGrid': 'Add New Product',
                'addReviewBtn': 'Add Review' // NEW translation
            },
            'KM': {
                'dashboardTitle': '',
                'totalOrdersTitle': '',
                'recentOrdersTitle': '',
                'productsTitle': '',
                'ordersTitle': '',
                'customersTitle': '',
                'transactionsTitle': '',
                'reviewsTitle': '',
                'notificationsTitle': '',
                'messagesTitle': '',
                'couponsTitle': '',
                'reportsTitle': '',
                'settingsTitle': '',
                'newOrderBtn': '',
                'addProductBtn': '',
                'addCustomerBtn': '',
                'transactionHistoryTitle': '',
                'filterAll': '',
                'filterDay': '',
                'filterWeek': '',
                'filterMonth': '',
                'addProdBtnGrid': '',
                'addReviewBtn': '' // NEW translation
            },
            'ZH': {
                'dashboardTitle': '',
                'totalOrdersTitle': '',
                'recentOrdersTitle': '',
                'productsTitle': '',
                'ordersTitle': '',
                'customersTitle': '',
                'transactionsTitle': '',
                'reviewsTitle': '',
                'notificationsTitle': '',
                'messagesTitle': '',
                'couponsTitle': '',
                'reportsTitle': '',
                'settingsTitle': '',
                'newOrderBtn': '',
                'addProductBtn': '',
                'addCustomerBtn': '',
                'transactionHistoryTitle': '',
                'filterAll': '',
                'filterDay': '',
                'filterWeek': '',
                'filterMonth': '',
                'addProdBtnGrid': '',
                'addReviewBtn': '' // NEW translation
            }
        };

        // Products array
        let products = [];

        // Customers array
        let customers = [];

        // Orders array to store all created orders
        let orders = [];

        // Reviews array (NEW)
        let reviews = [];


        // Variable to hold the ID of the product currently being edited
        let currentEditingProductId = null;
        // Variable to hold the ID of the order currently being edited
        let currentEditingOrderId = null;
        // Variable to hold the ID of the customer currently being edited
        let currentEditingCustomerId = null; 
        // Variable to hold the ID of the customer currently being viewed in detail modal
        let currentViewingCustomerId = null; 
        // Variable to hold the ID of the review currently being edited (NEW)
        let currentEditingReviewId = null; 

        // Pagination for customers
        const customersPerPage = 9; // Display 9 customers per page as per image
        let currentCustomerPage = 1;

        // Set active section
        function setActiveSection(sectionId) {
            // Update sidebar active state
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if(link.dataset.section === sectionId) {
                    link.classList.add('active');
                }
            });
            
            // Show active section
            sectionContents.forEach(section => {
                section.classList.remove('active');
                if(section.id === sectionId) {
                    section.classList.add('active');
                    // Special handling for sections that need initial rendering
                    if (sectionId === 'transactions') {
                        renderTransactions('all'); 
                        document.querySelectorAll('.transaction-filters .btn').forEach(btn => btn.classList.remove('active-filter'));
                        filterAllBtn.classList.add('active-filter');
                    } else if (sectionId === 'customers') { 
                        currentCustomerPage = 1; // Reset to first page when entering customers section
                        renderCustomers(); // Re-render customers with pagination
                    } else if (sectionId === 'dashboard') { // Render top customers when dashboard is active
                        renderTopCustomersBySpent();
                        renderTopCustomersByCredit();
                    } else if (sectionId === 'reviews') { // NEW: Render reviews when reviews section is active
                        renderReviews();
                    }
                }
            });
            
            // Update header title based on i18n key (NEW)
            const activeLink = document.querySelector(`.nav-links a[data-section="${sectionId}"]`);
            if(activeLink) {
                const i18nKey = activeLink.dataset.i18nKey;
                if (i18nKey && translations[supportedLanguages[currentLanguageIndex].code][i18nKey]) {
                    headerTitle.textContent = translations[supportedLanguages[currentLanguageIndex].code][i18nKey];
                } else {
                    // If no specific key for header title, use the text from the active sidebar link
                    const activeLinkElement = document.querySelector('.nav-links a.active');
                    if (activeLinkElement) {
                        headerTitle.textContent = activeLinkElement.querySelector('span').textContent;
                    }
                }
                
                // Update header icon
                const iconClass = activeLink.querySelector('i').className;
                document.querySelector('.header h2 i').className = iconClass;
            }

            // Update all visible UI text after section change
            updateUIText();
        }

        // Show toast notification
        function showToast(message, isSuccess = true) {
            toastMessage.textContent = message;
            toast.className = isSuccess ? 'toast toast-success show' : 'toast toast-error show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Show modal with form
        function showModal(title, formContent) {
            modalTitle.textContent = title;
            modalBody.innerHTML = formContent;
            modal.classList.add('active');
        }

        // Show product modal
        function showProductModal() {
            productModalTitle.textContent = "Add New Product";
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('priceKhr').value = '';
            document.getElementById('saveProductBtn').innerHTML = '<i class="fas fa-save"></i> Save Product';
            currentEditingProductId = null; // Reset editing ID
            productModal.classList.add('active');
        }

        // Close modal
        function closeModalHandler() {
            modal.classList.remove('active');
        }

        // Close product modal
        function closeProductModalHandler() {
            productModal.classList.remove('active');
        }

        // Close customer modal
        function closeCustomerModalHandler() {
            customerModal.classList.remove('active');
        }

        // Close customer detail modal
        function closeCustomerDetailModalHandler() {
            customerDetailModal.classList.remove('active');
            redeemCreditAmountInput.value = ''; // Clear input field
            addCreditAmountInput.value = ''; // Clear input field
            // Reset currency selectors to USD
            redeemCreditCurrencySelect.value = 'USD';
            addCreditCurrencySelect.value = 'USD';
        }

        // Close summary modal
        function closeSummaryModalHandler() {
            summaryModal.classList.remove('active');
        }

        // Close review modal (NEW)
        function closeReviewModalHandler() {
            reviewModal.classList.remove('active');
        }

        // Initialize the app
        function initApp() {
            // Set dashboard as active
            setActiveSection('dashboard');
            
            // Set initial language display
            currentLanguageSpan.textContent = supportedLanguages[currentLanguageIndex].code;

            // Setup event listeners
            setupEventListeners();
            
            // Render products and orders (customers rendered when navigated to)
            renderProducts();
            renderOrders();
            renderReviews(); // NEW: Render reviews on init
            renderTopCustomersBySpent(); // Initial render for top customers
            renderTopCustomersByCredit(); // Initial render for top customers
            
            // Initial UI text update based on default language
            updateUIText();
        }

        // Format currency
        function formatCurrency(amount, currency) {
            if (currency === 'USD') {
                return '$' + amount.toFixed(2);
            } else if (currency === 'KHR') {
                // Convert USD to KHR
                const khrAmount = amount * USD_TO_KHR;
                // Format with commas and add currency symbol
                return khrAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '';
            }
            return amount.toFixed(2);
        }

        // Render products
        function renderProducts() {
            productsGrid.innerHTML = ''; // Clear existing products
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                // Add an onerror handler for images to provide a fallback placeholder
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.image}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e9ecef/6c757d?text=No+Image';">
                    </div>
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <span class="product-category">${product.category.charAt(0).toUpperCase() + product.category.slice(1)}</span>
                        <p class="product-description">${product.description}</p>
                        <div class="product-pricing">
                            <div class="price-usd">$${product.price.toFixed(2)}</div>
                            <div class="price-khr">${formatCurrency(product.price, 'KHR')}</div>
                        </div>
                        <div class="product-stock">
                            <div class="stock-info">
                                <div class="stock-indicator ${product.stock > 10 ? 'in-stock' : product.stock > 0 ? 'low-stock' : 'out-of-stock'}"></div>
                                <span>In Stock: ${product.stock}</span>
                            </div>
                            <div class="product-actions">
                                <button class="action-btn edit-btn" data-id="${product.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn delete-btn" data-id="${product.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
            
            // Add event listeners to newly rendered edit and delete buttons
            document.querySelectorAll('.products-grid .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Use currentTarget to ensure the button is found even if icon is clicked
                    const productId = parseInt(e.currentTarget.dataset.id); 
                    editProduct(productId);
                });
            });
            
            document.querySelectorAll('.products-grid .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.dataset.id);
                    deleteProduct(productId);
                });
            });
        }
        
        // Edit product
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                currentEditingProductId = id; // Set the ID of the product being edited
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('priceUsd').value = product.price;
                document.getElementById('priceKhr').value = (product.price * USD_TO_KHR).toFixed(0);
                document.getElementById('stockQuantity').value = product.stock;
                // Re-calculate status based on stock quantity as it can change dynamically
                let calculatedStatus = 'in-stock';
                if (product.stock <= 0) {
                    calculatedStatus = 'out-of-stock';
                } else if (product.stock <= 10) {
                    calculatedStatus = 'low-stock';
                }
                document.getElementById('stockStatus').value = calculatedStatus;
                
                // Show image preview if available
                if (product.image && product.image !== 'https://placehold.co/300x200/e9ecef/6c757d?text=No+Image') {
                    document.getElementById('imagePreview').src = product.image;
                    document.getElementById('imagePreview').style.display = 'block';
                } else {
                    document.getElementById('imagePreview').src = '';
                    document.getElementById('imagePreview').style.display = 'none';
                }
                
                productModalTitle.textContent = "Edit Product";
                document.getElementById('saveProductBtn').innerHTML = '<i class="fas fa-save"></i> Update Product';
                productModal.classList.add('active');
            }
        }
        
        // Delete product
        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) { 
                products = products.filter(p => p.id !== id);
                renderProducts();
                showToast('Product deleted successfully');
            }
        }

        // Render orders into the tables
        function renderOrders() {
            recentOrdersTableBody.innerHTML = ''; // Clear existing recent orders
            orderManagementTableBody.innerHTML = ''; // Clear existing management orders

            // Sort orders by date in descending order (most recent first)
            const sortedOrders = [...orders].sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            sortedOrders.forEach((order, index) => {
                const row = document.createElement('tr');
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const statusClass = order.status === 'Completed' ? 'status-active' :
                                    order.status === 'Processing' ? 'status-pending' :
                                    'status-inactive'; 

                row.innerHTML = `
                    <td>${order.orderId}</td>
                    <td>${order.customerName}</td>
                    <td>${order.orderDate}</td>
                    <td>${totalItems} items</td>
                    <td>$${order.grandTotal.toFixed(2)}</td>
                    <td>${formatCurrency(order.grandTotal, 'KHR')}</td>
                    <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" data-order-id="${order.orderId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" data-order-id="${order.orderId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-order-btn" data-order-id="${order.orderId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // Append to Recent Orders (show top 5)
                if (index < 5) { // Show only the 5 most recent orders on dashboard
                    recentOrdersTableBody.appendChild(row.cloneNode(true)); // Clone to prevent moving elements
                }
                // Append to Order Management (show all)
                orderManagementTableBody.appendChild(row);
            });

            // Add event listeners for view/edit/delete buttons in order tables
            document.querySelectorAll('#recentOrdersTableBody .view-btn, #orderManagementTableBody .view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.dataset.orderId;
                    const orderToView = orders.find(o => o.orderId === orderId);
                    if (orderToView) {
                        showOrderSummary(orderToView); // Reuse the summary modal
                    }
                });
            });

            document.querySelectorAll('#recentOrdersTableBody .edit-btn, #orderManagementTableBody .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.dataset.orderId;
                    const orderToEdit = orders.find(o => o.orderId === orderId);
                    if (orderToEdit) {
                        showOrderForm(orderToEdit); // Pass the order data for editing
                    }
                });
            });

            document.querySelectorAll('#recentOrdersTableBody .delete-order-btn, #orderManagementTableBody .delete-order-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.dataset.orderId;
                    deleteOrder(orderId);
                });
            });
        }

        // Delete order function
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order? This will not revert stock changes.')) {
                orders = orders.filter(o => o.orderId !== orderId);
                // Note: Deleting an order does NOT automatically revert stock or credit changes in this simple model.
                // For a more robust system, you'd need to implement complex logic to reverse these transactions.
                renderOrders();
                showToast(`Order ${orderId} deleted successfully!`);
            }
        }

        // Create order form HTML (now accepts optional orderData for editing)
        function createOrderForm(orderData = null) {
            currentEditingOrderId = orderData ? orderData.orderId : null; // Set current editing order ID

            // Generate product options for the select dropdowns
            // Product select options should include current stock level for visibility
            const productOptions = products.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">${p.name} (Stock: ${p.stock})</option>`).join('');

            // Generate initial order items rows
            let initialOrderItemsHtml = '';
            if (orderData && orderData.items && orderData.items.length > 0) {
                initialOrderItemsHtml = orderData.items.map(item => `
                    <tr>
                        <td>
                            <select class="product-select">
                                <option value="">Select product</option>
                                ${products.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}" ${parseInt(p.id) === parseInt(item.id) ? 'selected' : ''}>${p.name} (Stock: ${p.stock})</option>`).join('')}
                            </select>
                        </td>
                        <td class="usd-price">$${item.price.toFixed(2)}</td>
                        <td class="khr-price">${formatCurrency(item.price, 'KHR')}</td>
                        <td>
                            <input type="number" min="1" value="${item.quantity}" class="quantity" style="width: 70px;">
                        </td>
                        <td class="item-total">$${item.total.toFixed(2)}</td>
                        <td class="remove-item"><i class="fas fa-times"></i></td>
                    </tr>
                `).join('');
            } else {
                // Default single empty row for new order
                initialOrderItemsHtml = `
                    <tr>
                        <td>
                            <select class="product-select">
                                <option value="">Select product</option>
                                ${productOptions}
                            </select>
                        </td>
                        <td class="usd-price">$0.00</td>
                        <td class="khr-price">0</td>
                        <td>
                            <input type="number" min="1" value="1" class="quantity" style="width: 70px;">
                        </td>
                        <td class="item-total">$0.00</td>
                        <td class="remove-item"><i class="fas fa-times"></i></td>
                    </tr>
                `;
            }

            return `
                <form id="orderForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Customer Name *</label>
                            <input type="text" id="customerName" required placeholder="Enter customer name" value="${orderData ? orderData.customerName : ''}">
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone Number</label>
                            <input type="text" id="customerPhone" placeholder="Enter phone number" value="${orderData ? orderData.customerPhone : ''}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="orderDate">Order Date *</label>
                            <input type="date" id="orderDate" required value="${orderData ? orderData.orderDate : new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label for="orderId">Order ID</label>
                            <input type="text" id="orderId" value="${orderData ? orderData.orderId : '#ORD-' + Math.floor(Math.random() * 100000).toString().padStart(5, '0')}" readonly>
                        </div>
                    </div>
                    
                    <div class="order-settings">
                        <div class="setting-group">
                            <label for="taxRate">Tax Rate (%)</label>
                            <input type="number" id="taxRate" min="0" max="100" value="${orderData ? orderData.taxRate : '0'}">
                        </div>
                        <div class="setting-group">
                            <label for="pointRate">Point Rate (%)</label>
                            <input type="number" id="pointRate" min="0" max="100" value="${orderData ? orderData.pointRate : '0'}">
                        </div>
                        <div class="setting-group">
                            <label for="discountRate">Discount Rate (%)</label>
                            <input type="number" id="discountRate" min="0" max="100" value="${orderData ? orderData.discountRate : '0'}">
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 15px;">Order Items</h4>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price (USD)</th>
                                <th>Price (KHR)</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="orderItems">
                            ${initialOrderItemsHtml}
                        </tbody>
                    </table>
                    
                    <button type="button" class="add-item-btn" id="addItemBtn">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    
                    <div class="summary-card">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax (<span id="taxRateValue">10</span>%):</span>
                            <span id="tax">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Discount (<span id="discountRateValue">5</span>%):</span>
                            <span id="discount">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Points Applied (<span id="pointRateValue">5</span>%):</span>
                            <span id="points">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Applied Credit:</span>
                            <span id="appliedCreditDisplay">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Grand Total (USD):</span>
                            <span id="grandTotalUsd">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Grand Total (KHR):</span>
                            <span id="grandTotalKhr">0</span>
                        </div>
                        <div class="summary-row">
                            <span>Remaining Balance:</span>
                            <span id="remainingBalanceDisplay">$0.00</span>
                        </div>
                    </div>
                    
                    <!-- NEW: Payment Method Selection -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Payment Method</label>
                        <div style="display: flex; gap: 20px;">
                            <label>
                                <input type="radio" name="paymentMethod" value="cash" id="paymentCash" ${orderData?.paymentMethod === 'cash' || !orderData ? 'checked' : ''}> Cash
                            </label>
                            <label>
                                <input type="radio" name="paymentMethod" value="credit" id="paymentCredit" ${orderData?.paymentMethod === 'credit' ? 'checked' : ''}> Credit
                            </label>
                        </div>
                    </div>

                    <!-- NEW: Payment Amount Input -->
                    <div class="form-group" id="paymentAmountGroup">
                        <label for="paymentAmount">Amount Paid (Cash/Credit)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="paymentAmount" min="0" step="0.01" value="${orderData ? (orderData.paymentMethod === 'cash' ? orderData.paymentAmountRaw : orderData.paymentMethod === 'credit' ? orderData.paymentAmountRaw : '0.00') : '0.00'}">
                            <select id="paymentCurrency">
                                <option value="USD" ${orderData?.paymentCurrency === 'USD' || !orderData ? 'selected' : ''}>USD</option>
                                <option value="KHR" ${orderData?.paymentCurrency === 'KHR' ? 'selected' : ''}>KHR</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancelOrderForm">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submitOrderBtn">
                            <i class="fas fa-save"></i> ${orderData ? 'Update Order' : 'Create Order'}
                        </button>
                    </div>
                </form>
            `;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.dataset.section;
                    setActiveSection(sectionId);
                    
                    // Close sidebar on mobile after selection
                    if(window.innerWidth <= 992) {
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            // Menu toggle for mobile
            menuToggle?.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if(window.innerWidth <= 992 && 
                   !sidebar.contains(e.target) && 
                   !menuToggle.contains(e.target) && 
                   sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });
            
            // Close modals
            closeModal?.addEventListener('click', closeModalHandler);
            document.getElementById('closeProductModal')?.addEventListener('click', closeProductModalHandler);
            document.getElementById('cancelProductForm')?.addEventListener('click', closeProductModalHandler);
            closeSummaryModal?.addEventListener('click', closeSummaryModalHandler);
            doneSummaryBtn?.addEventListener('click', closeSummaryModalHandler); 
            closeCustomerModal?.addEventListener('click', closeCustomerModalHandler); 
            document.getElementById('cancelCustomerForm')?.addEventListener('click', closeCustomerModalHandler); 
            closeCustomerDetailModal?.addEventListener('click', closeCustomerDetailModalHandler);
            closeCustomerDetailBtn?.addEventListener('click', closeCustomerDetailModalHandler);
            closeReviewModal?.addEventListener('click', closeReviewModalHandler); // NEW
            document.getElementById('cancelReviewForm')?.addEventListener('click', closeReviewModalHandler); // NEW
            
            // Close modal when clicking outside
            modal?.addEventListener('click', (e) => {
                if(e.target === modal) {
                    closeModalHandler();
                }
            });
            
            productModal?.addEventListener('click', (e) => {
                if(e.target === productModal) {
                    closeProductModalHandler();
                }
            });
            
            customerModal?.addEventListener('click', (e) => { 
                if(e.target === customerModal) {
                    closeCustomerModalHandler();
                }
            });

            customerDetailModal?.addEventListener('click', (e) => {
                if(e.target === customerDetailModal) {
                    closeCustomerDetailModalHandler();
                }
            });

            summaryModal?.addEventListener('click', (e) => {
                if(e.target === summaryModal) {
                    closeSummaryModalHandler();
                }
            });

            reviewModal?.addEventListener('click', (e) => { // NEW
                if(e.target === reviewModal) {
                    closeReviewModalHandler();
                }
            });
            
            // Add order buttons
            addOrderBtn?.addEventListener('click', () => showOrderForm()); 
            addOrderBtn2?.addEventListener('click', () => showOrderForm()); 
            
            // Add product buttons
            addProductBtn?.addEventListener('click', showProductModal);
            addProductBtnGrid?.addEventListener('click', showProductModal);

            // Add customer button 
            addCustomerBtn?.addEventListener('click', () => showCustomerForm());

            // Add review button (NEW)
            addReviewBtn?.addEventListener('click', () => showReviewForm());
            
            // Product form submission
            document.getElementById('productForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form values
                const productName = document.getElementById('productName').value;
                const productCategory = document.getElementById('productCategory').value;
                const productDescription = document.getElementById('productDescription').value;
                const priceUsd = parseFloat(document.getElementById('priceUsd').value);
                const stockQuantity = parseInt(document.getElementById('stockQuantity').value);
                // Dynamically determine stock status based on quantity
                let calculatedStatus = 'in-stock';
                if (stockQuantity <= 0) {
                    calculatedStatus = 'out-of-stock';
                } else if (stockQuantity <= 10) {
                    calculatedStatus = 'low-stock';
                }
                const productImageSrc = document.getElementById('imagePreview').src; 
                
                // Basic validation
                if (!productName || !productCategory || isNaN(priceUsd) || isNaN(stockQuantity)) {
                    showToast('Please fill in all required fields with valid numbers for price and stock.', false);
                    return;
                }
                
                if (currentEditingProductId) {
                    // Update existing product
                    const productIndex = products.findIndex(p => p.id === currentEditingProductId);
                    if (productIndex !== -1) {
                        products[productIndex] = {
                            ...products[productIndex], 
                            name: productName,
                            category: productCategory,
                            description: productDescription,
                            price: priceUsd,
                            stock: stockQuantity,
                            status: calculatedStatus, // Use calculated status
                            image: productImageSrc || 'https://placehold.co/300x200/e9ecef/6c757d?text=No+Image' 
                        };
                        showToast(`Product "${productName}" updated successfully!`);
                    }
                } else {
                    // Create new product
                    const newProduct = {
                        id: products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1, 
                        name: productName,
                        category: productCategory,
                        description: productDescription,
                        price: priceUsd,
                        stock: stockQuantity,
                        status: calculatedStatus, // Use calculated status
                        image: productImageSrc || 'https://placehold.co/300x200/e9ecef/6c757d?text=No+Image'
                    };
                    products.push(newProduct);
                    showToast(`Product "${productName}" added successfully!`);
                }
                
                // Update products grid
                renderProducts();
                
                // Reset form and close modal
                this.reset();
                document.getElementById('imagePreview').src = '';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('priceKhr').value = '';
                closeProductModalHandler();
            });
            
            // Currency conversion in product modal
            document.getElementById('priceUsd')?.addEventListener('input', function() {
                if (this.value) {
                    const usdValue = parseFloat(this.value);
                    document.getElementById('priceKhr').value = (usdValue * USD_TO_KHR).toFixed(0);
                } else {
                    document.getElementById('priceKhr').value = '';
                }
            });

            // Stock quantity input handler to update status dynamically
            document.getElementById('stockQuantity')?.addEventListener('input', function() {
                const stockQty = parseInt(this.value);
                const stockStatusSelect = document.getElementById('stockStatus');
                if (stockQty <= 0) {
                    stockStatusSelect.value = 'out-of-stock';
                } else if (stockQty <= 10) {
                    stockStatusSelect.value = 'low-stock';
                } else {
                    stockStatusSelect.value = 'in-stock';
                }
            });
            
            // Image upload handling
            document.getElementById('imageUpload')?.addEventListener('click', function() {
                document.getElementById('productImage').click();
            });
            
            document.getElementById('productImage')?.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imagePreview = document.getElementById('imagePreview');
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Print button for Order Summary
            document.getElementById('printOrderBtn')?.addEventListener('click', () => {
                window.print(); 
                showToast('Printing order...', true);
            });

            // Save as Image button for Order Summary using html2canvas
            document.getElementById('saveOrderImageBtn')?.addEventListener('click', () => {
                const orderPrintContent = document.getElementById('orderPrintContent');
                html2canvas(orderPrintContent).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'order-summary.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    showToast('Order summary saved as image!', true);
                }).catch(error => {
                    console.error('Error saving image:', error);
                    showToast('Failed to save image. Please try again.', false);
                });
            });

            // Transaction filter buttons
            filterAllBtn?.addEventListener('click', () => {
                renderTransactions('all');
                updateFilterButtons('all');
            });
            filterDayBtn?.addEventListener('click', () => {
                renderTransactions('day');
                updateFilterButtons('day');
            });
            filterWeekBtn?.addEventListener('click', () => {
                renderTransactions('week');
                updateFilterButtons('week');
            });
            filterMonthBtn?.addEventListener('click', () => {
                renderTransactions('month');
                updateFilterButtons('month');
            });

            // Customer form submission 
            document.getElementById('customerForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const customerName = document.getElementById('customerProfileName').value;
                const customerPhone = document.getElementById('customerProfilePhone').value;
                const customerEmail = document.getElementById('customerProfileEmail').value;
                const customerPhotoSrc = document.getElementById('customerImagePreview').src; // Get image source

                if (!customerName) {
                    showToast('Customer name is required.', false);
                    return;
                }

                if (currentEditingCustomerId) {
                    // Update existing customer
                    const customerIndex = customers.findIndex(c => c.id === currentEditingCustomerId);
                    if (customerIndex !== -1) {
                        customers[customerIndex] = {
                            ...customers[customerIndex],
                            name: customerName,
                            phone: customerPhone,
                            email: customerEmail,
                            photo: customerPhotoSrc || '' // Update photo
                        };
                        showToast(`Customer "${customerName}" updated successfully!`);
                    }
                } else {
                    // Add new customer
                    const newCustomer = {
                        id: customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1,
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        totalOrders: 0,
                        totalSpent: 0,
                        credit: 0, // Explicitly initialize with 0 credit
                        creditHistory: [],
                        photo: customerPhotoSrc || '' // Add photo to new customer
                    };
                    customers.push(newCustomer);
                    showToast(`Customer "${customerName}" added successfully!`);
                }
                renderCustomers();
                closeCustomerModalHandler();
            });

            // Add Credit Button
            addCreditBtn?.addEventListener('click', () => {
                if (currentViewingCustomerId) {
                    const customer = customers.find(c => c.id === currentViewingCustomerId);
                    if (customer) {
                        const amountToAdd = parseFloat(addCreditAmountInput.value);
                        const currency = addCreditCurrencySelect.value;
                        
                        if (isNaN(amountToAdd) || amountToAdd <= 0) {
                            showToast('Please enter a valid amount to add.', false);
                            return;
                        }

                        let amountInUsd = amountToAdd;
                        if (currency === 'KHR') {
                            amountInUsd = amountToAdd / USD_TO_KHR;
                        }

                        customer.credit += amountInUsd;
                        
                        // Record the addition in history (can be adapted for 'add' type if needed)
                        const now = new Date();
                        customer.creditHistory.push({
                            date: now.toLocaleDateString(),
                            time: now.toLocaleTimeString(),
                            amount: amountToAdd, // Store original amount entered by user
                            currency: currency,
                            type: 'added' // New field to distinguish between added and redeemed
                        });

                        addCreditAmountInput.value = ''; // Clear input
                        showToast(`$${amountInUsd.toFixed(2)} (${amountToAdd.toFixed(2)} ${currency}) added to ${customer.name}'s credit. New credit: $${customer.credit.toFixed(2)}`);
                        showCustomerDetails(currentViewingCustomerId); // Re-render details to show updated credit and history
                        renderCustomers(); // Update main customer table
                        renderTopCustomersByCredit(); // Update top customers by credit
                    }
                }
            });


            // Redeem Credit Button
            redeemCreditBtn?.addEventListener('click', () => {
                if (currentViewingCustomerId) {
                    const customer = customers.find(c => c.id === currentViewingCustomerId);
                    if (customer) {
                        const amountToRedeem = parseFloat(redeemCreditAmountInput.value);
                        const currency = redeemCreditCurrencySelect.value;
                        
                        if (isNaN(amountToRedeem) || amountToRedeem <= 0) {
                            showToast('Please enter a valid amount to redeem.', false);
                            return;
                        }

                        let amountInUsdToDeduct = amountToRedeem;
                        if (currency === 'KHR') {
                            amountInUsdToDeduct = amountToRedeem / USD_TO_KHR;
                        }

                        if (amountInUsdToDeduct > customer.credit && customer.credit >= 0) { // Only check if current credit is positive
                            showToast('Insufficient credit balance.', false);
                            return;
                        }
                        // Allow credit to go negative if redeeming more than available, treating it as a new debt.
                        customer.credit -= amountInUsdToDeduct;
                        
                        // Record the redemption in history
                        const now = new Date();
                        customer.creditHistory.push({
                            date: now.toLocaleDateString(),
                            time: now.toLocaleTimeString(),
                            amount: amountToRedeem, // Store original amount entered by user
                            currency: currency,
                            type: 'redeemed' // New field
                        });

                        redeemCreditAmountInput.value = ''; // Clear input
                        showToast(`$${amountInUsdToDeduct.toFixed(2)} (${amountToRedeem.toFixed(2)} ${currency}) redeemed from ${customer.name}'s credit. New net balance: $${customer.credit.toFixed(2)}`);
                        showCustomerDetails(currentViewingCustomerId); // Re-render details to show updated credit and history
                        renderCustomers(); // Update main customer table
                        renderTopCustomersByCredit(); // Update top customers by credit
                    }
                }
            });

            // Language selector click event
            languageSelector?.addEventListener('click', () => {
                currentLanguageIndex = (currentLanguageIndex + 1) % supportedLanguages.length;
                currentLanguageSpan.textContent = supportedLanguages[currentLanguageIndex].code;
                updateUIText(); // Update all UI text immediately
                showToast(`Language set to ${supportedLanguages[currentLanguageIndex].name}`, true);
            });

            // Pagination button event listeners
            prevPageBtn?.addEventListener('click', () => {
                if (currentCustomerPage > 1) {
                    currentCustomerPage--;
                    renderCustomers();
                }
            });

            nextPageBtn?.addEventListener('click', () => {
                const totalPages = Math.ceil(customers.length / customersPerPage);
                if (currentCustomerPage < totalPages) {
                    currentCustomerPage++;
                    renderCustomers();
                }
            });

            // Customer Image Upload Handling
            customerImageUpload?.addEventListener('click', function() {
                customerPhotoInput.click();
            });
            
            customerPhotoInput?.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        customerImagePreview.src = e.target.result;
                        customerImagePreview.style.display = 'block';
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Customer search input event listener
            customerSearchInput?.addEventListener('input', () => {
                currentCustomerPage = 1; // Reset to first page on search
                renderCustomers();
            });

            // Review form submission (NEW)
            document.getElementById('reviewForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productId = parseInt(document.getElementById('reviewProduct').value);
                const customerId = parseInt(document.getElementById('reviewCustomer').value);
                const rating = parseInt(document.getElementById('reviewRating').value);
                const comment = document.getElementById('reviewComment').value;
                const reviewDate = new Date().toISOString().split('T')[0]; // Current date

                if (!productId || !customerId || !rating) {
                    showToast('Please fill in all required fields for the review.', false);
                    return;
                }

                const product = products.find(p => p.id === productId);
                const customer = customers.find(c => c.id === customerId);

                if (!product || !customer) {
                    showToast('Selected product or customer not found.', false);
                    return;
                }

                if (currentEditingReviewId) {
                    // Update existing review
                    const reviewIndex = reviews.findIndex(r => r.id === currentEditingReviewId);
                    if (reviewIndex !== -1) {
                        reviews[reviewIndex] = {
                            ...reviews[reviewIndex],
                            productId,
                            customerId,
                            rating,
                            comment,
                            date: reviewDate // Update date to current date on edit
                        };
                        showToast('Review updated successfully!');
                    }
                } else {
                    // Add new review
                    const newReview = {
                        id: reviews.length > 0 ? Math.max(...reviews.map(r => r.id)) + 1 : 1,
                        productId,
                        customerId,
                        rating,
                        comment,
                        date: reviewDate
                    };
                    reviews.push(newReview);
                    showToast('Review added successfully!');
                }
                
                renderReviews();
                closeReviewModalHandler();
            });
        }
        
        // Show order form (now accepts an optional order object for editing)
        function showOrderForm(orderToEdit = null) {
            showModal(orderToEdit ? 'Edit Order' : 'Create New Order', createOrderForm(orderToEdit));
            
            // Init form after content is rendered
            initOrderForm();
            updateOrderTotals(); // Calculate initial totals
        }
        
        // Initialize order form
        function initOrderForm() {
            // Add item functionality
            document.getElementById('addItemBtn')?.addEventListener('click', () => {
                const itemsContainer = document.getElementById('orderItems');
                const newRow = document.createElement('tr');
                // Include data-stock for the new row's product options
                const productOptions = products.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">${p.name} (Stock: ${p.stock})</option>`).join('');
                newRow.innerHTML = `
                    <td>
                        <select class="product-select">
                            <option value="">Select product</option>
                            ${productOptions}
                        </select>
                    </td>
                    <td class="usd-price">$0.00</td>
                    <td class="khr-price">0</td>
                    <td>
                        <input type="number" min="1" value="1" class="quantity" style="width: 70px;">
                    </td>
                    <td class="item-total">$0.00</td>
                    <td class="remove-item"><i class="fas fa-times"></i></td>
                `;
                itemsContainer.appendChild(newRow);
                
                // Add event listeners to new row
                addRowEventListeners(newRow);
                updateOrderTotals(); // Update totals after adding a new row
            });
            
            // Add event listeners to existing rows
            document.querySelectorAll('#orderItems tr').forEach(row => {
                addRowEventListeners(row);
            });
            
            // Tax, discount, point rate, and payment inputs
            document.getElementById('taxRate')?.addEventListener('input', updateOrderTotals);
            document.getElementById('discountRate')?.addEventListener('input', updateOrderTotals);
            document.getElementById('pointRate')?.addEventListener('input', updateOrderTotals);
            document.getElementById('paymentAmount')?.addEventListener('input', updateOrderTotals);
            document.getElementById('paymentCurrency')?.addEventListener('change', updateOrderTotals);

            // Payment method radio buttons
            document.getElementById('paymentCash')?.addEventListener('change', updateOrderTotals);
            document.getElementById('paymentCredit')?.addEventListener('change', updateOrderTotals);
            
            // Handle form submission
            document.getElementById('orderForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // Gather order data
                const customerName = document.getElementById('customerName').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const orderDate = document.getElementById('orderDate').value;
                const orderId = document.getElementById('orderId').value;
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                const pointRate = parseFloat(document.getElementById('pointRate').value) || 0;
                const paymentAmountRaw = parseFloat(document.getElementById('paymentAmount').value) || 0;
                const paymentCurrency = document.getElementById('paymentCurrency').value;
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                
                let paymentAmountUsd = paymentAmountRaw;
                if (paymentCurrency === 'KHR') {
                    paymentAmountUsd = paymentAmountRaw / USD_TO_KHR;
                }

                // Gather items and perform stock check
                const items = [];
                let subtotal = 0;
                let isValidOrder = true;
                const stockUpdates = []; // To store stock changes if order is successful

                document.querySelectorAll('#orderItems tr').forEach(row => {
                    const productSelect = row.querySelector('.product-select');
                    const selectedOption = productSelect.options[productSelect.selectedIndex];
                    const quantityInput = row.querySelector('.quantity');
                    
                    if (!selectedOption || !selectedOption.value || parseInt(quantityInput.value) <= 0) {
                        isValidOrder = false;
                        showToast('Please select a product and ensure quantity is at least 1 for all items.', false);
                        return;
                    }

                    const productId = parseInt(selectedOption.value);
                    const productName = selectedOption.text.split(' (Stock:')[0]; // Clean name from option text
                    const price = parseFloat(selectedOption.dataset.price);
                    const quantity = parseInt(quantityInput.value) || 0;
                    const availableStock = parseInt(selectedOption.dataset.stock);

                    // --- STOCK CHECK ---
                    if (quantity > availableStock) {
                        isValidOrder = false;
                        showToast(`Insufficient stock for "${productName}". Only ${availableStock} left.`, false);
                        return; // Stop processing and return early if stock is insufficient
                    }
                    // --- END STOCK CHECK ---
                    
                    const total = price * quantity;
                    subtotal += total;

                    items.push({
                        id: productId,
                        name: productName,
                        price: price,
                        quantity: quantity,
                        total: total
                    });
                    stockUpdates.push({ productId: productId, quantityChange: quantity });
                });

                if (!isValidOrder) {
                    return; // Stop form submission if any validation (including stock) failed
                }

                if (items.length === 0) {
                    showToast('Please add at least one item to the order.', false);
                    return;
                }
                
                // Calculate totals considering all deductions
                const tax = subtotal * (taxRate / 100);
                const discount = subtotal * (discountRate / 100);
                const points = subtotal * (pointRate / 100);
                let grandTotal = subtotal + tax - discount - points;

                if (grandTotal < 0) {
                    grandTotal = 0;
                }
                
                let appliedCredit = 0;
                let cashPaid = 0;

                let customer = customers.find(c => c.name === customerName);
                if (!customer) {
                    customer = customers.find(c => c.phone === customerPhone);
                }
                
                if (paymentMethod === 'credit') {
                    if (!customer) {
                        showToast('Customer not found. Cannot apply credit.', false);
                        return;
                    }
                    if (paymentAmountUsd > customer.credit && customer.credit >= 0) {
                        showToast(`Insufficient credit balance for ${customer.name}. Available credit: $${customer.credit.toFixed(2)}`, false);
                        return;
                    }
                    appliedCredit = paymentAmountUsd;
                    customer.credit -= appliedCredit;

                    const now = new Date();
                    customer.creditHistory.push({
                        date: now.toLocaleDateString(),
                        time: now.toLocaleTimeString(),
                        amount: paymentAmountRaw,
                        currency: paymentCurrency,
                        type: 'redeemed (order)' 
                    });
                } else {
                    cashPaid = paymentAmountUsd;
                }

                let remainingBalance = grandTotal - appliedCredit - cashPaid;

                const orderObject = {
                    customerName,
                    customerPhone,
                    orderDate,
                    orderId,
                    items,
                    subtotal,
                    tax,
                    discount,
                    points,
                    appliedCredit,
                    cashPaid,
                    remainingBalance,
                    grandTotal,
                    taxRate,
                    discountRate,
                    pointRate,
                    paymentMethod,
                    paymentAmountRaw,
                    paymentCurrency,
                    status: "Processing"
                };

                // --- STOCK DEDUCTION / REVERSION FOR EDITING ---
                if (currentEditingOrderId) {
                    // When editing, revert stock from the previous version of the order first
                    const prevOrder = orders.find(o => o.orderId === currentEditingOrderId);
                    if (prevOrder) {
                        prevOrder.items.forEach(prevItem => {
                            const productToUpdate = products.find(p => p.id === prevItem.id);
                            if (productToUpdate) {
                                productToUpdate.stock += prevItem.quantity; // Add back previous quantity
                            }
                        });
                        // Also revert previous credit/balance changes if any, to re-apply correctly
                        if (customer) {
                             // This is a simplified reversion. A full solution would need to analyze creditHistory
                             // to precisely undo the specific credit/debt change associated with the previous order state.
                             // For now, we only revert the 'remainingBalance' adjustment for simplicity and to prevent
                             // double-deduction/addition on simple edits.
                            customer.credit += prevOrder.remainingBalance;
                            // Remove previous credit history entry related to this order update
                            customer.creditHistory = customer.creditHistory.filter(entry =>
                                !(entry.type.includes('(order)') && entry.amount === Math.abs(prevOrder.remainingBalance) && new Date(`${entry.date} ${entry.time}`).toDateString() === new Date(`${prevOrder.orderDate}`).toDateString())
                            );
                        }
                    }
                    const orderIndex = orders.findIndex(o => o.orderId === currentEditingOrderId);
                    if (orderIndex !== -1) {
                        orders[orderIndex] = orderObject;
                        showToast(`Order ${orderId} updated successfully!`);
                    }
                } else {
                    orders.push(orderObject);
                    showToast(`Order ${orderId} created successfully!`);
                }

                // Deduct new stock quantities for the current order (after potential reversion for edits)
                stockUpdates.forEach(update => {
                    const productToUpdate = products.find(p => p.id === update.productId);
                    if (productToUpdate) {
                        productToUpdate.stock -= update.quantityChange;
                        // Update product status based on new stock
                        if (productToUpdate.stock <= 0) {
                            productToUpdate.status = 'out-of-stock';
                        } else if (productToUpdate.stock <= 10) {
                            productToUpdate.status = 'low-stock';
                        } else {
                            productToUpdate.status = 'in-stock';
                        }
                    }
                });
                // --- END STOCK DEDUCTION ---

                if (customer && orderObject.remainingBalance !== 0) {
                    customer.credit -= orderObject.remainingBalance;
                    const now = new Date();
                    customer.creditHistory.push({
                        date: now.toLocaleDateString(),
                        time: now.toLocaleTimeString(),
                        amount: Math.abs(orderObject.remainingBalance),
                        currency: 'USD',
                        type: orderObject.remainingBalance > 0 ? 'owed (order)' : 'overpaid (order)'
                    });
                }

                updateCustomerDataFromOrder(orderObject);

                showOrderSummary(orderObject);

                renderOrders();
                renderProducts(); // Re-render products to show updated stock
                renderTopCustomersBySpent();
                renderTopCustomersByCredit();
                
                closeModalHandler();
            });
            
            document.getElementById('cancelOrderForm')?.addEventListener('click', closeModalHandler);
        }
        
        // Add event listeners to a product row in the order form
        function addRowEventListeners(row) {
            const productSelect = row.querySelector('.product-select');
            const quantityInput = row.querySelector('.quantity');
            const removeBtn = row.querySelector('.remove-item');
            
            // Product selection
            productSelect?.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption && selectedOption.value ? parseFloat(selectedOption.dataset.price) : 0;
                
                if (price) {
                    row.querySelector('.usd-price').textContent = '$' + price.toFixed(2);
                    row.querySelector('.khr-price').textContent = formatCurrency(price, 'KHR');
                } else {
                    row.querySelector('.usd-price').textContent = '$0.00'; // Default if no product selected
                    row.querySelector('.khr-price').textContent = '0';
                }
                
                calculateRowTotal(row);
                updateOrderTotals();
            });
            
            // Quantity change
            quantityInput?.addEventListener('input', () => {
                // Ensure quantity is not negative
                if (parseInt(quantityInput.value) < 0) {
                    quantityInput.value = 0;
                }
                // Also, ensure quantity does not exceed available stock
                const productSelect = row.querySelector('.product-select');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const availableStock = selectedOption && selectedOption.value ? parseInt(selectedOption.dataset.stock) : Infinity; // Use Infinity if no product selected
                
                let currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity > availableStock) {
                    quantityInput.value = availableStock; // Cap at available stock
                    showToast(`Cannot order more than available stock (${availableStock}).`, false);
                } else if (currentQuantity < 1 && quantityInput.value !== '') { // Prevent ordering 0 or negative
                    quantityInput.value = 1;
                }
                calculateRowTotal(row);
                updateOrderTotals();
            });
            
            // Remove item
            removeBtn?.addEventListener('click', function() {
                // Ensure there's always at least one row in the order form
                const itemsContainer = document.getElementById('orderItems');
                if (itemsContainer.children.length > 1) {
                    this.closest('tr').remove();
                    updateOrderTotals();
                } else {
                    showToast('An order must have at least one item.', false);
                }
            });

            // Trigger change event initially for existing rows (for default product and prices)
            // This is important for newly added rows or when opening an existing order for edit
            productSelect?.dispatchEvent(new Event('change'));
        }
        
        // Calculate total for a single row in the order form
        function calculateRowTotal(row) {
            const productSelect = row.querySelector('.product-select');
            const quantityInput = row.querySelector('.quantity');
            const itemTotal = row.querySelector('.item-total');
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = selectedOption && selectedOption.value ? parseFloat(selectedOption.dataset.price) : 0;
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (price && quantity) {
                const total = price * quantity;
                itemTotal.textContent = '$' + total.toFixed(2);
            } else {
                itemTotal.textContent = '$0.00';
            }
        }
        
        // Update overall order totals (subtotal, tax, discount, grand total, remaining balance)
        function updateOrderTotals() {
            let subtotal = 0;
            
            // Calculate subtotal from all items
            document.querySelectorAll('#orderItems tr').forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.quantity');
                
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const price = selectedOption && selectedOption.value ? parseFloat(selectedOption.dataset.price) : 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (price && quantity) {
                    subtotal += price * quantity;
                }
            });
            
            // Get tax, discount, and point rates
            const taxRateInput = document.getElementById('taxRate');
            const discountRateInput = document.getElementById('discountRate');
            const pointRateInput = document.getElementById('pointRate');
            const paymentAmountInput = document.getElementById('paymentAmount');
            const paymentCurrencySelect = document.getElementById('paymentCurrency');
            const paymentCashRadio = document.getElementById('paymentCash');
            const paymentCreditRadio = document.getElementById('paymentCredit');

            const taxRate = taxRateInput ? parseFloat(taxRateInput.value) || 0 : 0;
            const discountRate = discountRateInput ? parseFloat(discountRateInput.value) || 0 : 0;
            const pointRate = pointRateInput ? parseFloat(pointRateInput.value) || 0 : 0;
            
            // Calculate tax, discount, and points
            const tax = subtotal * (taxRate / 100);
            const discount = subtotal * (discountRate / 100);
            const points = subtotal * (pointRate / 100);
            
            let grandTotalUsd = subtotal + tax - discount - points;
            // Ensure grand total does not go below zero due to discounts/points
            if (grandTotalUsd < 0) {
                grandTotalUsd = 0;
            }
            let grandTotalKhr = grandTotalUsd * USD_TO_KHR;

            let appliedCredit = 0;
            let cashPaid = 0;
            let remainingBalance = grandTotalUsd; // Initialize with full grand total

            if (paymentAmountInput && paymentCurrencySelect) {
                const paymentAmountRaw = parseFloat(paymentAmountInput.value) || 0;
                const paymentCurrency = paymentCurrencySelect.value;
                let paymentAmountUsd = paymentAmountRaw;
                if (paymentCurrency === 'KHR') {
                    paymentAmountUsd = paymentAmountRaw / USD_TO_KHR;
                }

                if (paymentCreditRadio?.checked) {
                    appliedCredit = paymentAmountUsd;
                } else { // Cash payment
                    cashPaid = paymentAmountUsd;
                }
            }
            
            remainingBalance = grandTotalUsd - appliedCredit - cashPaid; // Remaining balance can now be negative for overpayment

            // Update display in the order form's summary card
            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('taxRateValue').textContent = taxRate;
            document.getElementById('tax').textContent = '$' + tax.toFixed(2);
            document.getElementById('discountRateValue').textContent = discountRate;
            document.getElementById('discount').textContent = '$' + discount.toFixed(2);
            document.getElementById('pointRateValue').textContent = pointRate;
            document.getElementById('points').textContent = '$' + points.toFixed(2);
            document.getElementById('appliedCreditDisplay').textContent = '$' + appliedCredit.toFixed(2);
            document.getElementById('grandTotalUsd').textContent = '$' + grandTotalUsd.toFixed(2);
            document.getElementById('grandTotalKhr').textContent = formatCurrency(grandTotalUsd, 'KHR'); // KHR display
            
            let remainingBalanceText = '';
            if (remainingBalance > 0) {
                remainingBalanceText = `$${remainingBalance.toFixed(2)} (Owed)`;
            } else if (remainingBalance < 0) {
                remainingBalanceText = `$${Math.abs(remainingBalance).toFixed(2)} (Credit to Customer)`;
            } else {
                remainingBalanceText = `$0.00`;
            }
            document.getElementById('remainingBalanceDisplay').textContent = remainingBalanceText;
        }
        
        // Show order summary modal with data
        function showOrderSummary(orderData) {
            // Populate summary data
            document.getElementById('summaryOrderId').textContent = orderData.orderId;
            document.getElementById('summaryOrderDate').textContent = orderData.orderDate;
            document.getElementById('summaryCustomer').textContent = orderData.customerName;
            document.getElementById('summaryPhone').textContent = orderData.customerPhone || 'N/A';
            
            // Populate items table in summary
            const itemsContainer = document.getElementById('summaryItems');
            itemsContainer.innerHTML = ''; // Clear previous items
            
            orderData.items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>$${(item.price * item.quantity).toFixed(2)}</td>
                `;
                itemsContainer.appendChild(row);
            });
            
            // Populate totals in summary
            document.getElementById('summarySubtotal').textContent = `$${orderData.subtotal.toFixed(2)}`;
            document.getElementById('summaryTaxRate').textContent = orderData.taxRate;
            document.getElementById('summaryTax').textContent = `$${orderData.tax.toFixed(2)}`;
            document.getElementById('summaryDiscountRate').textContent = orderData.discountRate;
            document.getElementById('summaryDiscount').textContent = `$${orderData.discount.toFixed(2)}`;
            document.getElementById('summaryPointRate').textContent = orderData.pointRate;
            document.getElementById('summaryPoints').textContent = `$${orderData.points.toFixed(2)}`;
            document.getElementById('summaryAppliedCredit').textContent = `$${orderData.appliedCredit.toFixed(2)}`;
            document.getElementById('summaryCashPaid').textContent = `$${orderData.cashPaid.toFixed(2)}`;
            document.getElementById('summaryGrandTotalUsd').textContent = `$${orderData.grandTotal.toFixed(2)}`;
            document.getElementById('summaryGrandTotalKhr').textContent = formatCurrency(orderData.grandTotal, 'KHR'); // KHR display
            
            let summaryRemainingBalanceText = '';
            if (orderData.remainingBalance > 0) {
                summaryRemainingBalanceText = `$${orderData.remainingBalance.toFixed(2)} (Owed)`;
            } else if (orderData.remainingBalance < 0) {
                summaryRemainingBalanceText = `$${Math.abs(orderData.remainingBalance).toFixed(2)} (Credit to Customer)`;
            } else {
                summaryRemainingBalanceText = `$0.00`;
            }
            document.getElementById('summaryRemainingBalance').textContent = summaryRemainingBalanceText;
            
            // Show the summary modal
            summaryModal.classList.add('active');
        }

        // Render transactions based on filter type
        function renderTransactions(filterType) {
            transactionsTableBody.innerHTML = ''; // Clear existing transactions
            let filteredOrders = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day for comparison

            if (filterType === 'all') {
                filteredOrders = orders;
            } else if (filterType === 'day') {
                filteredOrders = orders.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    orderDate.setHours(0, 0, 0, 0);
                    return orderDate.getTime() === today.getTime();
                });
            } else if (filterType === 'week') {
                const oneWeekAgo = new Date(today); 
                oneWeekAgo.setDate(today.getDate() - 7); 

                filteredOrders = orders.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    orderDate.setHours(0, 0, 0, 0);
                    return orderDate >= oneWeekAgo && orderDate <= today;
                });
            } else if (filterType === 'month') {
                filteredOrders = orders.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    return orderDate.getMonth() === today.getMonth() &&
                           orderDate.getFullYear() === today.getFullYear();
                });
            }

            // Sort filtered orders by date descending
            filteredOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            if (filteredOrders.length === 0) {
                transactionsTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--gray);">No transactions found for this period.</td></tr>`;
                return;
            }

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                const statusClass = order.status === 'Completed' ? 'status-active' :
                                    order.status === 'Processing' ? 'status-pending' :
                                    'status-inactive';

                row.innerHTML = `
                    <td>${order.orderId.replace('#ORD-', '#TRANS-')}</td> 
                    <td>${order.orderId}</td>
                    <td>${order.customerName}</td>
                    <td>${order.orderDate}</td>
                    <td>$${order.grandTotal.toFixed(2)}</td>
                    <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                `;
                transactionsTableBody.appendChild(row);
            });
        }

        // Update active class on filter buttons
        function updateFilterButtons(activeFilter) {
            document.querySelectorAll('.transaction-filters .btn').forEach(btn => {
                if (btn.dataset.filter === activeFilter) {
                    btn.classList.add('active-filter');
                } else {
                    btn.classList.remove('active-filter');
                }
            });
        }

        // Render customers (now with pagination and grid)
        function renderCustomers() {
            customerGrid.innerHTML = ''; // Clear existing customer cards
            
            const searchTerm = customerSearchInput.value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.phone.toLowerCase().includes(searchTerm) ||
                customer.email.toLowerCase().includes(searchTerm)
            );

            const startIndex = (currentCustomerPage - 1) * customersPerPage;
            const endIndex = startIndex + customersPerPage;
            const customersToDisplay = filteredCustomers.slice(startIndex, endIndex);

            if (customersToDisplay.length === 0) {
                customerGrid.innerHTML = '<p style="text-align: center; color: var(--gray);">No customers found.</p>';
            } else {
                customersToDisplay.forEach(customer => {
                    const customerCard = document.createElement('div');
                    customerCard.className = 'customer-card-item';
                    customerCard.innerHTML = `
                        <div class="profile-avatar">
                            <img src="${customer.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(customer.name)}&background=random&color=fff`}" alt="${customer.name}" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(customer.name)}&background=random&color=fff';">
                        </div>
                        <div class="profile-info">
                            <div class="profile-name">${customer.name}</div>
                            <div class="customer-card-actions">
                                <button class="action-btn view-profile-btn" data-id="${customer.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="action-btn edit-btn" data-id="${customer.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn delete-btn" data-id="${customer.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    customerGrid.appendChild(customerCard);
                });
            }

            // Update pagination button states based on filtered customers
            const totalPages = Math.ceil(filteredCustomers.length / customersPerPage);
            prevPageBtn.disabled = currentCustomerPage === 1;
            nextPageBtn.disabled = currentCustomerPage === totalPages || filteredCustomers.length === 0;

            // Add event listeners to newly rendered detail, edit and delete buttons
            document.querySelectorAll('.customer-card-item .view-profile-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const customerId = parseInt(e.currentTarget.dataset.id);
                    showCustomerDetails(customerId);
                });
            });

            document.querySelectorAll('.customer-card-item .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const customerId = parseInt(e.currentTarget.dataset.id);
                    editCustomer(customerId);
                });
            });

            document.querySelectorAll('.customer-card-item .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const customerId = parseInt(e.currentTarget.dataset.id);
                    deleteCustomer(customerId);
                });
            });
        }

        // Show customer form
        function showCustomerForm(customerToEdit = null) {
            currentEditingCustomerId = customerToEdit ? customerToEdit.id : null;
            customerModalTitle.textContent = customerToEdit ? 'Edit Customer' : 'Add New Customer';
            document.getElementById('customerForm').reset(); 
            document.getElementById('saveCustomerBtn').innerHTML = `<i class="fas fa-save"></i> ${customerToEdit ? 'Update Customer' : 'Save Customer'}`;
            
            if (customerToEdit) {
                document.getElementById('customerProfileName').value = customerToEdit.name;
                document.getElementById('customerProfilePhone').value = customerToEdit.phone;
                document.getElementById('customerProfileEmail').value = customerToEdit.email;
                
                // Show customer photo preview if available
                if (customerToEdit.photo) {
                    customerImagePreview.src = customerToEdit.photo;
                    customerImagePreview.style.display = 'block';
                } else {
                    customerImagePreview.src = '';
                    customerImagePreview.style.display = 'none';
                }

            } else {
                // For new customer, clear preview
                customerImagePreview.src = '';
                customerImagePreview.style.display = 'none';
            }
            customerModal.classList.add('active');
        }

        // Edit customer
        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                showCustomerForm(customer);
            }
        }

        // Delete customer
        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer? All associated orders will remain.')) {
                customers = customers.filter(c => c.id !== id);
                renderCustomers(); // Re-render customers with updated list and pagination
                showToast('Customer deleted successfully!');
            }
        }

        // Update customer data based on a new or updated order
        function updateCustomerDataFromOrder(order) {
            let customer = customers.find(c => c.name === order.customerName);

            if (customer) {
                // Ensure totalOrders and totalSpent are accurately recalculated
                customer.totalOrders = orders.filter(o => o.customerName === customer.name).length;
                // Total spent should be the sum of grandTotal of all orders by this customer
                customer.totalSpent = orders.filter(o => o.customerName === customer.name)
                                           .reduce((sum, o) => sum + o.grandTotal, 0);
            } else {
                // Create new customer if not found
                const newCustomerId = customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1;
                customers.push({
                    id: newCustomerId,
                    name: order.customerName,
                    phone: order.customerPhone,
                    email: '', 
                    totalOrders: 1, // This is the first order for this new customer
                    totalSpent: order.grandTotal, // Initial total spent is the grand total of this order
                    credit: 0, // All new customers start with 0 credit/net balance
                    creditHistory: [],
                    photo: '' // Default empty photo
                });
            }
            // Re-render customers to reflect changes (if on customer page)
            if (document.getElementById('customers').classList.contains('active')) {
                renderCustomers();
            }
            renderTopCustomersBySpent(); // Update top customers by spent
            renderTopCustomersByCredit(); // Update top customers by credit
        }

        // Show customer details modal
        function showCustomerDetails(id) {
            currentViewingCustomerId = id;
            const customer = customers.find(c => c.id === id);

            if (customer) {
                document.getElementById('detailCustomerName').textContent = customer.name;
                document.getElementById('detailCustomerPhone').textContent = customer.phone || 'N/A';
                document.getElementById('detailCustomerEmail').textContent = customer.email || 'N/A';
                
                // Calculate actual total orders and total spent based on orders array
                const customerOrders = orders.filter(order => order.customerName === customer.name);
                const totalOrders = customerOrders.length;
                const totalSpentUsd = customerOrders.reduce((sum, order) => sum + order.grandTotal, 0); // Sum of grand totals
                const totalSpentKhr = totalSpentUsd * USD_TO_KHR;

                // Credit balance in USD and KHR (now represents net balance, can be positive or negative)
                const netBalanceUsd = customer.credit;
                const netBalanceKhr = customer.credit * USD_TO_KHR;

                document.getElementById('detailTotalOrders').textContent = totalOrders;
                document.getElementById('detailCustomerTotalSpentUsd').textContent = `$${totalSpentUsd.toFixed(2)}`;
                document.getElementById('detailCustomerTotalSpentKhr').textContent = formatCurrency(totalSpentUsd, 'KHR');
                
                // Display net balance with appropriate label (Credit or Owed)
                let netBalanceUsdText = '';
                if (netBalanceUsd >= 0) {
                    netBalanceUsdText = `$${netBalanceUsd.toFixed(2)} (Credit)`;
                } else {
                    netBalanceUsdText = `-$${Math.abs(netBalanceUsd).toFixed(2)} (Owed)`;
                }
                document.getElementById('detailCustomerCreditUsd').textContent = netBalanceUsdText;

                let netBalanceKhrText = '';
                if (netBalanceKhr >= 0) {
                    netBalanceKhrText = `${formatCurrency(netBalanceKhr, 'KHR')} (Credit)`;
                } else {
                    netBalanceKhrText = `-${formatCurrency(Math.abs(netBalanceKhr), 'KHR')} (Owed)`;
                }
                document.getElementById('detailCustomerCreditKhr').textContent = netBalanceKhrText;
                
                // Render credit redemption history
                renderCreditHistory(customer.creditHistory);

                // Render customer-specific orders
                renderCustomerOrders(customerOrders);

                customerDetailModal.classList.add('active');
            }
        }

        // Render credit redemption history
        function renderCreditHistory(history) {
            creditHistoryTableBody.innerHTML = ''; // Clear previous history
            if (history && history.length > 0) {
                noCreditHistoryMessage.style.display = 'none';
                creditHistorySection.style.display = 'block';
                // Sort history by date/time descending (most recent first)
                history.sort((a, b) => {
                    const dateA = new Date(`${a.date} ${a.time}`);
                    const dateB = new Date(`${b.date} ${b.time}`);
                    return dateB - dateA;
                });

                history.forEach(record => {
                    const row = document.createElement('tr');
                    // Format amount based on recorded currency
                    const formattedAmount = record.currency === 'USD' ? `$${record.amount.toFixed(2)}` : `${record.amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                    
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.time}</td>
                        <td>${formattedAmount}</td>
                        <td>${record.currency}</td>
                        <td>${record.type.charAt(0).toUpperCase() + record.type.slice(1)}</td>
                    `;
                    creditHistoryTableBody.appendChild(row);
                });
            } else {
                creditHistorySection.style.display = 'block'; // Still show section, but with message
                noCreditHistoryMessage.style.display = 'block';
            }
        }

        // NEW: Render customer-specific orders in the detail modal
        function renderCustomerOrders(customerOrders) {
            customerOrdersTableBody.innerHTML = ''; // Clear previous orders
            if (customerOrders && customerOrders.length > 0) {
                noCustomerOrdersMessage.style.display = 'none';
                customerOrdersSection.style.display = 'block';

                // Sort orders by date descending (most recent first)
                customerOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                customerOrders.forEach(order => {
                    const row = document.createElement('tr');
                    const statusClass = order.status === 'Completed' ? 'status-active' :
                                        order.status === 'Processing' ? 'status-pending' :
                                        'status-inactive';

                    row.innerHTML = `
                        <td>${order.orderId}</td>
                        <td>${order.orderDate}</td>
                        <td>$${order.grandTotal.toFixed(2)}</td>
                        <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                        <td>
                            <button class="action-btn view-btn" data-order-id="${order.orderId}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    `;
                    customerOrdersTableBody.appendChild(row);
                });

                // Add event listeners for the new "View" buttons in this table
                document.querySelectorAll('#customerOrdersTableBody .view-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const orderId = e.currentTarget.dataset.orderId;
                        const orderToView = orders.find(o => o.orderId === orderId);
                        if (orderToView) {
                            showOrderSummary(orderToView);
                        }
                    });
                });
            } else {
                customerOrdersSection.style.display = 'block'; // Still show section, but with message
                noCustomerOrdersMessage.style.display = 'block';
            }
        }


        // Render Top 30 Customers by Total Spent
        function renderTopCustomersBySpent() {
            topCustomersSpentTableBody.innerHTML = ''; // Clear existing data
            const sortedCustomers = [...customers].sort((a, b) => b.totalSpent - a.totalSpent);
            const top30 = sortedCustomers.slice(0, 30); // Get top 30

            if (top30.length === 0) {
                topCustomersSpentTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--gray);">No customer data available.</td></tr>`;
                return;
            }

            top30.forEach((customer, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${customer.name}</td>
                    <td>$${customer.totalSpent.toFixed(2)}</td>
                `;
                topCustomersSpentTableBody.appendChild(row);
            });
        }

        // Render Top 30 Customers by Net Balance (Credit)
        function renderTopCustomersByCredit() {
            topCustomersCreditTableBody.innerHTML = ''; // Clear existing data
            // Filter for positive credit balances and sort in descending order
            const sortedCustomers = [...customers].filter(c => c.credit > 0).sort((a, b) => b.credit - a.credit);
            const top30 = sortedCustomers.slice(0, 30); // Get top 30

            if (top30.length === 0) {
                topCustomersCreditTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--gray);">No customers with credit balance.</td></tr>`;
                return;
            }

            top30.forEach((customer, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${customer.name}</td>
                    <td>$${customer.credit.toFixed(2)}</td>
                `;
                topCustomersCreditTableBody.appendChild(row);
            });
        }

        // Render Reviews (NEW)
        function renderReviews() {
            reviewsTableBody.innerHTML = ''; // Clear existing reviews

            if (reviews.length === 0) {
                reviewsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--gray);">No reviews found.</td></tr>`;
                return;
            }

            reviews.forEach(review => {
                const product = products.find(p => p.id === review.productId);
                const customer = customers.find(c => c.id === review.customerId);
                const productName = product ? product.name : 'Unknown Product';
                const customerName = customer ? customer.name : 'Unknown Customer';

                // Generate star rating HTML
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<i class="fa${i <= review.rating ? 's' : 'r'} fa-star"></i>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#REV-${review.id.toString().padStart(3, '0')}</td>
                    <td>${productName}</td>
                    <td>${customerName}</td>
                    <td><span class="rating-stars">${starsHtml}</span></td>
                    <td>${review.comment || 'N/A'}</td>
                    <td>${review.date}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-id="${review.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${review.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                reviewsTableBody.appendChild(row);
            });

            // Add event listeners to newly rendered edit and delete buttons for reviews
            document.querySelectorAll('#reviewsTableBody .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reviewId = parseInt(e.currentTarget.dataset.id);
                    editReview(reviewId);
                });
            });
            
            document.querySelectorAll('#reviewsTableBody .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reviewId = parseInt(e.currentTarget.dataset.id);
                    deleteReview(reviewId);
                });
            });
        }

        // Show Review Form Modal (NEW)
        function showReviewForm(reviewToEdit = null) {
            currentEditingReviewId = reviewToEdit ? reviewToEdit.id : null;
            reviewModalTitle.textContent = reviewToEdit ? 'Edit Review' : 'Add New Review';
            document.getElementById('reviewForm').reset();
            document.getElementById('saveReviewBtn').innerHTML = `<i class="fas fa-save"></i> ${reviewToEdit ? 'Update Review' : 'Save Review'}`;

            // Populate product and customer dropdowns
            const productSelect = document.getElementById('reviewProduct');
            const customerSelect = document.getElementById('reviewCustomer');
            
            productSelect.innerHTML = '<option value="">Select product</option>' + products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            customerSelect.innerHTML = '<option value="">Select customer</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            if (reviewToEdit) {
                document.getElementById('reviewProduct').value = reviewToEdit.productId;
                document.getElementById('reviewCustomer').value = reviewToEdit.customerId;
                document.getElementById('reviewRating').value = reviewToEdit.rating;
                document.getElementById('reviewComment').value = reviewToEdit.comment;
            }
            reviewModal.classList.add('active');
        }

        // Edit Review (NEW)
        function editReview(id) {
            const review = reviews.find(r => r.id === id);
            if (review) {
                showReviewForm(review);
            }
        }

        // Delete Review (NEW)
        function deleteReview(id) {
            if (confirm('Are you sure you want to delete this review?')) {
                reviews = reviews.filter(r => r.id !== id);
                renderReviews();
                showToast('Review deleted successfully!');
            }
        }

        // Function to update all UI text based on the current language
        function updateUIText() {
            const currentLangCode = supportedLanguages[currentLanguageIndex].code;
            const currentTranslations = translations[currentLangCode];

            // Update sidebar navigation links
            document.querySelectorAll('.nav-links a').forEach(link => {
                const i18nKey = link.dataset.i18nKey;
                if (i18nKey && currentTranslations[i18nKey]) {
                    link.querySelector('span').textContent = currentTranslations[i18nKey];
                }
            });

            // Update main header title
            const headerTitleSpan = document.querySelector('.header h2 span');
            const headerI18nKey = headerTitleSpan.dataset.i18nKey;
            if (headerI18nKey && currentTranslations[headerI18nKey]) {
                headerTitleSpan.textContent = currentTranslations[headerI18nKey]; // Changed i18nKey to headerI18nKey
            } else {
                 // If no specific key for header title, use the text from the active sidebar link
                 const activeLink = document.querySelector('.nav-links a.active');
                 if (activeLink) {
                     headerTitleSpan.textContent = activeLink.querySelector('span').textContent;
                 }
            }


            // Update stat card titles
            document.querySelector('.stat-card .stat-info .stat-title[data-i18n-key="totalOrdersTitle"]').textContent = currentTranslations['totalOrdersTitle'];

            // Update content headers
            document.querySelector('#dashboard .content-container .content-header h3[data-i18n-key="recentOrdersTitle"]').textContent = currentTranslations['recentOrdersTitle'];
            document.querySelector('#products .content-container .content-header h3[data-i18n-key="productsTitle"]').textContent = currentTranslations['productsTitle'];
            document.querySelector('#orders .content-container .content-header h3[data-i18n-key="ordersTitle"]').textContent = currentTranslations['ordersTitle'];
            document.querySelector('#customers .content-container .content-header h3[data-i18n-key="customersTitle"]').textContent = currentTranslations['customersTitle'];
            document.querySelector('#transactions .content-container .content-header h3[data-i18n-key="transactionHistoryTitle"]').textContent = currentTranslations['transactionHistoryTitle'];
            document.querySelector('#reviews .content-container .content-header h3[data-i18n-key="reviewsTitle"]').textContent = currentTranslations['reviewsTitle']; // NEW

            // Update button texts
            document.getElementById('addOrderBtn').textContent = currentTranslations['newOrderBtn'];
            document.getElementById('addOrderBtn2').textContent = currentTranslations['newOrderBtn'];
            document.getElementById('addProductBtn').textContent = currentTranslations['addProductBtn'];
            document.getElementById('addProductBtnGrid').textContent = currentTranslations['addProdBtnGrid'];
            document.getElementById('addCustomerBtn').textContent = currentTranslations['addCustomerBtn'];
            document.getElementById('addReviewBtn').textContent = currentTranslations['addReviewBtn']; // NEW

            // Update transaction filter buttons
            document.getElementById('filterAll').textContent = currentTranslations['filterAll'];
            document.getElementById('filterDay').textContent = currentTranslations['filterDay'];
            document.getElementById('filterWeek').textContent = currentTranslations['filterWeek'];
            document.getElementById('filterMonth').textContent = currentTranslations['filterMonth'];
        }

        // Initialize the application when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
